# AI設定仕様書

## 最終更新
- 日時: 2024-04-29
- 更新者: Claude
- ステータス: Draft

## 1. OpenAI API設定

### 1.1 APIキー管理
- 環境変数: `OPENAI_API_KEY`
- 保存場所: `.env`ファイル（Gitignore対象）
- 開発環境: 開発用APIキーを使用
- 本番環境: 本番用APIキーを使用（別アカウント）

### 1.2 セキュリティ対策
- APIキーのローテーション: 3ヶ月ごと
- 使用制限: 月間予算の設定
- エラー時のフォールバック: ローカルキャッシュを使用

## 2. プロンプト設計

### 2.1 食事写真分析プロンプト
```typescript
const FOOD_ANALYSIS_PROMPT = `
与えられた食事の写真を分析し、以下の情報を抽出してください：

1. 料理名（日本語）
2. 推定カロリー（kcal）
3. 栄養素推定値
   - タンパク質（g）
   - 脂質（g）
   - 炭水化物（g）
4. 特記事項（アレルギー、健康メモなど）

回答は以下のJSON形式で提供してください：
{
  "dishName": string,
  "calories": number,
  "nutrients": {
    "protein": number,
    "fat": number,
    "carbs": number
  },
  "notes": string[]
}
`;
```

### 2.2 カロリー収支アドバイスプロンプト
```typescript
const CALORIE_ADVICE_PROMPT = `
以下のデータを基に、カロリー収支に関するアドバイスを生成してください：

1. 本日の摂取カロリー: {totalIntakeCalories}
2. 本日の消費カロリー: {totalEnergyBurned}
3. カロリー収支: {netCalories}
4. 過去7日間の平均収支: {weeklyAverageNet}

以下の形式でアドバイスを提供してください：
{
  "summary": string, // 1文での要約
  "advice": string,  // 具体的なアドバイス（3文以内）
  "actionItems": string[] // 実行可能な行動項目（2-3個）
}
`;
```

## 3. アドバイス生成仕様

### 3.1 生成頻度
- 基本: ユーザーの手動更新時のみ
- 制限: 1時間に3回まで
- キャッシュ: 同じ日のデータに対しては既存の結果を再利用

### 3.2 形式
- 文字数: 要約20-30文字、アドバイス100-150文字
- 言語: 日本語のみ
- トーン: フレンドリーかつ専門的

### 3.3 保存方法
- ストレージキー: `advice:{YYYY-MM-DD}`
- 保持期間: 30日間
- 圧縮: なし

## 4. エラーハンドリング

### 4.1 APIエラー
- リトライ回数: 最大3回
- インターバル: 指数バックオフ（1秒、2秒、4秒）
- タイムアウト: 10秒

### 4.2 解析エラー
- 不正なレスポンス形式: デフォルト値を使用
- 画像認識失敗: 手動入力モードに切り替え
- その他: エラーメッセージを表示し再試行を促す 